---
output:
  pdf_document: 
    toc: true
    toc_depth: 2
title: 'Carpobrotus IPM notes'

---

# Data Notes

We have 13 sites with 6567 ramets that were found at $t$, and 4281 that were found again at $t+1$. I have not included density dependence. This is because due to the clonal nature of iceplants, and our drone sampling that can't distinguish genets, we do not know if a neighboring plant is competing or is the same plant. I don't think it would make sense to attempt a density dependent model in light of this. 

> From personal observation, it does not seem that neighboring iceplants do much to inhibit each other anyway (think kilometers-long stretches of shore line in Portugal or California where you see literally nothing but iceplant). I feel comfortable excluding this from the overall analysis. 
  
## Climate plots

affected vital rate X climate combos (from exploratory plots `ipms/Figures/clim/`). Ignores historical variables (i.e. 1970-2003). I don't think we really care about these in the context of current fitness.

  + Mean Annual precip (2016-2018): `-` pr(repro) (heavy), `-` survival (light)
  
  + Mean Annual temp (2016-2018): `+` pr(repro) (VVVVV heavy), `-` survival (light)
  
  + precip Seasonality (2016-2018): `+` pr(repro), `-` survival (heavy)
  
  + temp coldest month (2016-2018): `+` pr(repro) and survival (light-ish)
  
  + temp coldest quarter (2016-2018): ibid
  
  + temp seasonality (2016-2018): `+` pr(repro), `-` survival (heavy)
    
# Vital Rate Models - Climate

Climate drivers of demography. $z,z'$ are `log(size)`, `log(size_next)`. $\theta$ is generically some climate variable. Currently, climate variables are all separate models because they're all pretty correlated (`t_seas_rec` seems to have that huge outlier which gives it low coefficients. seems pretty correlated w the others without that point).

## Climate correlation plots and matrix 

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.height = 8, fig.width = 8, dpi = 450}
library(dplyr)
library(brms)

x <- readRDS("../Data/all_ramets_di.rds")

use <- x %>% 
  select(mat_rec:p_seas_rec) %>%
  distinct()

pairs(use)
round(cor(use), 3)

use_clim <- x %>%
  select(site, mat_rec:p_seas_rec, log_size)

```

`mat_rec` = mean annual temp, `map_rec` = mean annual precip, `t_co_mo` = temp coldest month, `t_co_qu` = mean temp coldest quarter, `p_seas`/`t_seas` = precip/temp seasonality.

## Model overview

Model selection is WAIC, and fits are checked using posterior predictive checks. Fitting done w/ `brms` using `cmdstanr` back end. With the exception of recruit size, all model selection used the following three candidate models:

1. `<vital_rate> ~ log_size + (1|site)`

2. `<vital_rate> ~ log_size + <climate_var> + (1|site)` (no interaction)

3. `<vital_rate> ~ log_size * <climate_var> + (1|site)` (has interaction)

Model specific notes are below. 

```{r echo = FALSE}
library(ggplot2)

plot_preds <- function(models, clim_data, has_is = "yes") {
  
  
  
  sites <- switch(has_is,
                  "yes" = c("Melkboss", "Rough_Island", 
                          "Havatselet", "Praia_de_Areao"),
                  "no"  = c("Melkboss", "Rough_Island", 
                            "Foxton", "Praia_de_Areao"))
  
  plt_title <- switch(has_is,
                  "yes" = "Includes Israel",
                  "no"  = "Excludes Israel")
    
  
  clim <- filter(clim_data, site %in% sites)
  
  use_clim <- clim_data %>%
    select(-log_size) %>% 
    group_by(site) %>% 
    summarise(mat_rec     = unique(mat_rec),
              map_rec     = unique(map_rec),
              t_seas_rec  = unique(t_seas_rec),
              p_seas_rec  = unique(p_seas_rec),
              t_co_qu_rec = unique(t_co_qu_rec))
  
  z <- c(models[[1]]$size_only$data$log_size,
         models[[1]]$size_only$data$log_size_next)
  
  min_z <- min(z, na.rm = TRUE)
  max_z <- max(z, na.rm = TRUE)
  
  pred_data <- data.frame(
    log_size = rep(seq(min_z, max_z, length.out = 100), 4),
    site     = c(
      rep(sites[1], 100),
      rep(sites[2], 100),
      rep(sites[3], 100),
      rep(sites[4], 100)
    )
  ) %>%
    left_join(use_clim, by = "site")
  
  temp <- list()
  
  for(i in seq_along(models)) {
    
    clim_nm <- names(models)[i]
    use_mods <- models[[i]][1:3]
    
    preds <- lapply(use_mods,
                    function(x, pred_data) {
                      temp <- predict(x, newdata = pred_data)
                      cbind(pred_data, temp)
                    },
                    pred_data = pred_data)
    
    for(j in seq_along(preds)) {
      preds[[j]] <- as.data.frame(preds[[j]]) %>%
        mutate(mod_type = names(preds)[j])
    } 
    
    temp[[i]] <- do.call(rbind, preds) %>% 
      mutate(clim = clim_nm)
    
  }
  
  all_data <- do.call(rbind, temp) 
  
  plt <- ggplot(all_data, 
                aes(x = log_size,
                    y = Estimate)) + 
    geom_line(aes(linetype = mod_type, 
                  color = site),
              size = 1.2,
              alpha = 0.6) + 
    facet_wrap(~clim, 
               scales = "free") +
    ylab("Estimated Vital Rate Value") + 
    theme_bw() +
    ggtitle(plt_title)
  
  print(plt)
}

plot_coefs <- function(models) {
  
  all_coefs <- list()
  for(i in seq_along(models)) {
    
    temp_coefs <- lapply(models[[i]][1:3],
                         function(x){ 
                           temp <- fixef(x) %>%
                             as.data.frame() %>%
                             mutate(par = rownames(.)) %>%
                             filter(grepl("sigma", par)) %>%
                             mutate(param = case_when(
                               grepl("Intercept", par) ~ "Intercept",
                               par == "sigma_log_size" ~ "Size",
                               grepl(":", par) ~ "Interaction", 
                               TRUE ~ "Climate"
                             )) %>%
                             as_tibble()
                           
                         })
    
    for(j in seq_along(temp_coefs)) {
      
      temp_coefs[[j]] <- mutate(temp_coefs[[j]],
                                mod_type = names(temp_coefs)[j],
                                clim = names(models)[i])
    }
    
    all_coefs <- c(all_coefs, temp_coefs)
    
  }
  
  all_coefs <- do.call(rbind, all_coefs)
  all_coefs$param <- ordered(all_coefs$param,
                             levels = c("Intercept",
                                        "Size", 
                                        "Climate", 
                                        "Interaction"))
  
  ggplot(all_coefs, aes(x = mod_type, y = Estimate)) + 
    geom_point(aes(color = param), shape = 15, size = 1.2) + 
    facet_wrap(~ clim) + theme_bw() + 
    geom_hline(yintercept = 0) + 
    geom_linerange(aes(ymin = Q2.5, ymax = Q97.5)) + 
    coord_flip() +
    scale_color_manual(
      breaks = c("Intercept",
                 "Size", 
                 "Climate", 
                 "Interaction"),
      values = c("black", "red", "blue", "orange")
      
    )
  
  
}

```

## Survival (bernoulli, n = 6567)

- mean Precip

  + Quantitatively, climate interaction is by far best, strong positive interaction, possibly 0 slope though point estimate is positive. Qualitatively, looks like the effect size is minimal, though there is a boost for the wee little ones at the native Melkboss. 

- Mean temp

  + Quantitatively, climate interaction by far best. Strong negative interaction, which dramatically reduces survival of biggest plants in Israel, but only small effects for smol plants elsewhere.  
  
- Precip seasonality

  + climate interaction by far best. strong negative interaction, which dramatically reduces survival of biggest plants in Israel, but only small, if any, effects elsewhere. 
  
- temp seasonality

  + climate interaction by far best. strong negative interaction and strong negative slope, which dramatically reduces survival of biggest plants in Israel, but seemingly no qualitative effect elsewhere.
  
- coldest quarter

  + Quantitatively, climate interaction by far best. Strong negative interaction, but the 0-ish slope reduces the practical effect size to basically 0. The wee tots get a boost in Melkboss and take an L at Rough Island in New Zealand, but no real effect elsewhere.
  
**Overall impressions**: Big Carpobrotus actually doesn't like Israel all that much while smaller ones positively adore the Holy Land. While there are some boosts to smaller plants, especially at the native Melkboss, overall, unobserved site specific variability is having more effect than our examined climate drivers (even if those climate drivers do explain some variance). I think the next step is to investigate +/- 0.2 SD climate (i.e. not tooooo distant future climate) for our sites and see what the future may hold.

**Probable functional form**: $s(z,\theta) = \frac{1}{1+e^{\beta_{0[i],s}} + \beta_{1,s} *z + \beta_{2,s} * \theta + \beta_{3,s} * z * \theta}$ where $\beta_{0[i]}$ refers to site-specific random intercepts.

\newpage
```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 9, fig.width = 6.5, fig.cap = "Survival model predictions. Includes 4 sites (to demonstrate random intercept variability without over cluttering the graph), and show predictions for each model. If you can't see the short or long dashed lines, it's because the models are different enough and they're all making basically the same predictions. These predictions show climate held steady at the value the site experienced."}

mod_list <- readRDS("../Model_Fits/ramet_survival_list.rds")

plot_preds(mod_list, use_clim)

```
\newpage


\newpage
## Growth (Gaussian, Exp($\sigma$), n = 4281)

> For all of these models, the size coefficients for the variance are negative. Sometimes the best model has a negative climate coefficient, sometimes not. See graphs for variance coefficient plots

- Mean precip

  + Climate interaction model is best. Positive relationship w climate. positive but probable 0 climate slope and definite positive interaction. Basically 0 qualitative effect size.
  
- Mean temp

  + Climate interaction is best. slope estimate is 0, but interaction is positive.  Basically 0 qualitative effect size.
  
- Precip seasonality

  + Climate interaction is best. The climate slope point estimate is positive but also likely 0, but the interaction term is negative. So in general all plants (might) grow more on average, but increased seasonality (definitely) reduces the average increment for big plants. However, basically 0 qualitative effect size.
  
- Temp seasonality

  + climate  interaction is best but within WAIC margin of error. climate slope may be positive, but with wide posterior w/ mean very close to 0. interaction may be negative, but also wide posterior very w/ mean very close to 0. However,  Basically 0 qualitative effect size.
  
- coldest quarter

  + Climate interaction is best. slope estimate is 0, but interaction is negative. However,  Basically 0 qualitative effect size.
  
**Overall impression**: This vital rate has way more site-specific variability than climtate-driven variability. Probably won't even bother tweaking this one, unless either TMK or RSG feels a strong desire to see what that looks like. The growth variance may show something interesting, but I'm still working out how to visualize that one in a more interesting way.

**Probable functional form**: 

1. $G(z'|z,\theta) = f_G(z'|mu_G(z,\theta), \sigma_G(z, \theta))$ ($f_G$ is Gaussian density function).

2. $\mu_{G} = \beta_{0[i],G} + \beta_{1,G} * z + \beta_{2,G} * \theta + \beta_{3,G} * z * \theta$ where $\beta_{0[i]}$ refers to site-specific random intercepts.

3. $\sigma_{G} = e^{\beta_{4,G} + \beta_{5,G} * z + \beta_{6,G} * \theta + \beta_{7,G} * z * \theta}$


\newpage

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 9, fig.width = 6.5, fig.cap = "Growth model predictions. Includes 4 sites (to demonstrate random intercept variability without over cluttering the graph), and show predictions for each model. If you can't see the short or long dashed lines, it's because the models are different enough and they're all making basically the same predictions.  These predictions show climate held steady at the value the site experienced. I think the next step is to investigate +/- 0.2 SD climate (i.e. not tooooo distant future climate)."}

mod_list <- readRDS("../Model_Fits/ramet_grow_list.rds")

plot_preds(mod_list, use_clim)

```
\newpage
\newpage
```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 9, fig.width = 6.5, fig.cap = "Growth Model variance coefficients. Whiskers denote 2.5 and 97.5% quantiles from posterior distributions."}

plot_coefs(mod_list)

```
\newpage

\newpage
## Flower Number (Negative binomial, n = 1093)

- Mean Precip

  + Interaction performs slightly better than other two, within margin of error. Climate slope is negative but overlapping 0, and interaction is positive (not overlapping 0).
  
- Mean Temp

  + Interaction performs slightly better than other two, within margin of error. Climate slope is positive but overlapping 0, and interaction is negative (not overlapping 0).
  
- Precip seasonality

  + Interaction performs slightly better than other two, within margin of error. Climate slope is positive but overlapping 0, and interaction is negative (not overlapping 0).
  
- Temp seasonality

  + All of these models are basically equivalent. No interaction model is slightly better, but within WAIC margin of error. Climate slope is negative but overlapping 0
  
- Temp Coldest quarter

  + Interaction performs slightly better than other two, within margin of error. Climate slope is positive but overlapping 0, and interaction is negative (not overlapping 0).
  
**Overall impressions**: Mostly site-specific variability. I don't see much separation of the curves here. Furthermore, climate effect sizes are teeny tiny compared to plant size and site-specific variation - no real practical effect even if it is technically there. 

**Probable IPM form**: $r_n(z) = e^{\beta_{0[i],r_n} + \beta_{1,r_n} * z}$ where $\beta_{0[i]}$ refers to site-specific random intercepts.

\newpage
```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 9, fig.width = 6.5, fig.cap = "Flower model predictions. Includes 4 sites (to demonstrate random intercept variability without over cluttering the graph), and show predictions for each model. If you can't see the short or long dashed lines, it's because the models are different enough and they're all making basically the same predictions.  These predictions show climate held steady at the value the site experienced. I think the next step is to investigate +/- 0.2 SD climate (i.e. not tooooo distant future climate)."}

mod_list <- readRDS("../Model_Fits/ramet_flower_n_list.rds")

plot_preds(mod_list, use_clim)

```
\newpage

\newpage
## Pr(flowering) (Bernoulli, n = 6581)

- Mean precip

  + Interaction slightly preferred. Slope estimate is negative, but overlaps w/ 0, while interaction is positive and not overlapping w/ 0.
  

- mean temp

  + All models equally likely. Climate slopes are positive and interaction is negative, but all overlap 0, so no effect supported by the model.

  - Precip seasonality

  + Size only model preferred
  
- Temp seasonality

  + Interaction slightly preferred, but within margin of error of other models. Relationship is positive for both slope and interaction. Basically no qualitative effect.

- Temp coldest quarter

  + Interaction slightly preferred, but within margin of error of other models. slope is positive, but likely 0, and interaction is negative and non-overlapping w/ 0


**Overall impressions**: Mostly site-specific variability. I don't see much separation of the curves here. 

**Probable IPM form**: $r_p(z) = \frac{1}{1 + e^{\beta_{0[i],r_p} + \beta_{1,r_p * z} + \beta_{2, r_p} * \theta + \beta_{3,r_p} * z * \theta}}$ where $\beta_{0[i]}$ refers to site-specific random intercepts.

\newpage

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 9, fig.width = 6.5, fig.cap = "Pr(flowering) model predictions. Includes 4 sites (to demonstrate random intercept variability without over cluttering the graph), and show predictions for each model. If you can't see the short or long dashed lines, it's because the models are different enough and they're all making basically the same predictions.  These predictions show climate held steady at the value the site experienced. I think the next step is to investigate +/- 0.2 SD climate (i.e. not tooooo distant future climate)."}

mod_list <- readRDS("../Model_Fits/ramet_repro_list.rds")

plot_preds(mod_list, use_clim)

```
\newpage
\newpage

## Recruit size (n = 15)

No climate effects here because we only have data from one site (Rooisand, South Africa. Native range)! Model looks fine as $r_d(z') = f_{r_d}(z'|\mu_{r_d}, \sigma_{r_d})$ (log scale), $f_{r_d}$ is Gaussian. 

```{r echo = FALSE}

mod <- readRDS("../Model_Fits/recr_size_brm.rds")

summary(mod)

```

\newpage

# Native/Invasive models

As with the climate models, model selection is WAIC, and fits are checked using posterior predictive checks. Fitting done w/ `brms` using `cmdstanr` back end. With the exception of recruit size, all model selection used the following three candidate models:

1. `<vital_rate> ~ log_size + (1|site)`

2. `<vital_rate> ~ log_size + native + (1|site)` (no interaction)

3. `<vital_rate> ~ log_size * native + (1|site)` (has interaction)

### Survival (bernoulli, n = 6567)

The `size * native` interaction model is chose, and not within WAIC margin of error. The slope is positive, but with a good deal of uncertainty ($\beta_{nat} \sim N(1.04, 0.6)$). The interaction is positive and has a good deal less certainty ($\beta_{nat,z} \sim N(0.18, 0.05)$). So in general, plants do survive better in the native range. This is pretty unexpected. 

```{r echo = FALSE}
knitr::include_graphics(
  "../Figures/vr_models/survival_native_model_predictions.pdf"
)

```

### Growth (Gaussian, Exp($\sigma$), n = 4281)

The `size * native` interaction model is preferred, and not within WAIC margin of error. THe slope estimate is negative, but with high uncertainty ($\beta_{nat} \sim N(-0.11, 0.2)$). The interaction coefficient is negative with less uncertainty ($\beta_{nat,z} \sim N(-.0.04, 0.02)$). The estimated magnitude is quite small, so is unlikely to have much effect. However, slower growth in the native range may provide hints as to differential dominance...

The coefficients related to the growth variance are of interest in this. Nativity has a positive slope $\beta_{nat, \sigma} \sim N(0.2, 0.03)$, and the interaction coefficient for $\sigma$ is also positive. The slope for size is negative ($\beta_{z,\sigma} \sim N(-0.14, 0.01)$) but actually has a smaller magnitude than that for nativity. I suspet this could make a difference in the IPM. This implies more variable growth in the native range, and even more variable growth (or shrinakge) for larger plants in the native range. 

```{r echo = FALSE}
knitr::include_graphics(
  "../Figures/vr_models/growth_native_model_predictions.pdf"
)

```

## P-kernel notes

Carpobrotus seems to survive better, but grow slower in the native range. This slower growth may be offset by greater variability in growth of larger plants. This may lead to real differences in population dynamics between native and invaded range. However, there does appear to be at least as much site-specific variability, and that variance may be more important.

### Flower Number (Negative binomial, n = 1093)

The `size + native` model is chosen, but within the WAIC margin of error. Plots show that site specific variation really is the main driver here. The interaction model does show a slightly negative interaction, but apparently doesn't have as much out of sample predictive power as the non-interaction model. The latter shows a slightly positive effect of nativity (point estimate), but the posterior is wide ($\beta_{nat} \sim N(0.13, 0.42)$). 

I don't think we can reasonably argue plants make fewer flowers in the native range. 

```{r echo = FALSE}

knitr::include_graphics(
  "../Figures/vr_models/flower_n_native_model_predictions.pdf"
)


```

### Pr(flowering) (Bernoulli, n = 6581)

The `size * native` interaction model is chose, and not within WAIC margin of error. The native slope estimate positive, but considerably uncertain ($\beta_{nat} \sim N(0.33, 0.92)$). The interaction is negative with far less uncertainty ($\beta_{nat,z} \sim N(-0.25, 0.07)$), so bigger plants are less likely to flower in the native range. 

```{r echo = FALSE}
knitr::include_graphics(
  "../Figures/vr_models/repro_native_model_predictions.pdf"
)

```

## F-kernel notes

Bigger plants are less likely to flower, but those that do seem to produce as many flowers as their invasive counterparts. Whether or not this produces an appreciable effect w/r/t to population dynamics remains to be seen.

However, there does appear to be at least as much site-specific variability, and that variance may be more important.

# Further analyses

1. Re-fit models without Havatselet, because this outlier seems to be driving the interaction terms to non-0 values in the models (it's the only site that seems affected).

  + **Done**, makes no difference. Climate effect sizes seem to be dwarfed by plant size and site-specific variability. 

2. Nativity analysis

  + There appear to be some differences here that are worth investigating. This needs to be IPM'd before anything conclusive can emerge though, so... next step!

3. Combine into an IPM and investigate sensitivity to climate across complete lifecycle.

  + will send update on how that's structured soon. Suspect will have 2 discrete stages (seedbank + "seedlings before visible to drone camera") and 1 continuous ("plants visible to drone camera"). Need to investigate seedbank stuff a bit more.

4. Decompose into contributions of nativity to current fitness. 


That's all for now, folks!

## Rob meeting

use some more environmental variables. Once you get a wider set, dimensional reduction, then use those axes in models with nativity.

    + Keep interactions in this model meaningful. Nativity * size, axis 1 * size, axis 2 * size. Don't go 3-way interaction.

Probably not worth diving into sliding windows with only 1 transition. That is going to be a shitshow, and unlikely to yield anything anyway since temporal replication is essential.

## Tiffany meeting

Take climate from year before for reproduction, and year of transition for survival growth. Then combine per Rob's suggestion and go forward from there. Those are the time frames that should affect it, ignoring potential lags in sliding window because that'll be a nightmare w/ only 1 transition. 

- southern hemisphere: 

    + repro: Sept 2017-2018
    
    + surv/grow: Sept 2018-2019
    
- PT:
    
    + repro: March 2018-2019
    
    + surv/grow: March 2019-2020
    
- IS: 
    
    + repro: April 2017-2018
    
    + surv/grow: April 2018-2019
    
## From both

Retain nativity and keep looking for climate signal. Tiffany will be furious if I ditch that, so try some more stuff. Or just keep the negative signal in the dissertation to keep her happy. But don't quit!

# Genetics stuff

Spoke with Ana Novoa on January 20. Genetics data are analyzed and pretty much ready!

**Big picture**:

1. identified 3 main genetic clusters throughout the global range. They all appear in South Africa, and all have hybridized with each other to varying degrees in different populations. 

2. Wanted to create hybrids from each cluster in the green house, but had problems getting seeds imported to CZ.

    + Couldn't really do it. permitting issues w the EU
    
3. Germination data is mostly done, though missing some seeds from South Africa which are currently en route. The latter should be germinated/analyzed by May.

    + I'm not going to wait for these data unless things are *really* different from population to population/genetic cluster to genetic cluster.
    
## Data


### Genetics

Used microsatellites. They're an older technique, but still valid apparently. The three clusters are roughly geographically grouped. 

> Extracted whole genome, then extracted segment that had variability (microsatellite). Computed proportion of region belonging to each cluster for all individual samples. This variable is Dirichlet distributed w/ 3 options. Need to work out how to use that in IPMs/subsequent analyses. 

Not really any correlation w/ traits collected in the field. Maybe some correlation w/ pop size structure though... need to check! 

higher inbreeding, less heterozygosity in native range. Ana suggested there may be less pollination going on in native range, or that cloning is more common in invaded range (and founder populations were fairly heterozygous). That's an area for more study in the future (I think).  

### Germination 

various treatments based on seeds from populations in each cluster (e.g. humidity, pH). 

have data from all clusters in some places, but not all populations. I think this is ok for us provided variance isn't excessive.


## TO dos

1. Get genetics and germ data from Ana.

2. Stick those in an IPM/subsequent analysis

3. also look for correlates of cluster/drone based trait data and send those back to Ana.

**Potentially Required Coauthors to use this data:**

genetics data: Ana must be included, Jaco Le Roux, Dave Richardson. 

germination data: Ana must be included, and two postdocs in Petr Pysek's group. 



